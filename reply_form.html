<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>新聞採訪回覆表單 | News Interview Reply Form</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 設定全域字體為 Inter 或通用無襯線字體 */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 2rem 1rem;
        }
    </style>
</head>
<body>

    <div id="app-container" class="w-full max-w-4xl bg-white p-8 md:p-12 shadow-2xl rounded-xl border border-gray-100">
        
        <!-- 表單標頭 -->
        <header class="mb-8 border-b pb-4">
            <h1 class="text-3xl font-extrabold text-gray-900 mb-2">新聞採訪回覆表單</h1>
            <p class="text-lg text-gray-500">News Interview Reply Form</p>
            <p id="certification-info" class="text-xs text-gray-400 mt-4">
                Powered by News Interview Blockchain App, Certified by CHIA-YUAN HSU (Reporter).
            </p>
        </header>

        <!-- 主要內容區塊 -->
        <main>
            <div id="question-display" class="bg-indigo-50 p-6 rounded-lg mb-8 border-l-4 border-indigo-500">
                <h2 class="text-xl font-semibold text-indigo-800 mb-3">請回答以下問題：</h2>
                <div id="question-content" class="text-gray-700 text-lg whitespace-pre-wrap">
                    <p>正在載入問題...</p>
                </div>
                <p class="text-sm text-indigo-600 mt-4">您的回覆將被數位存證。</p>
            </div>

            <div id="error-message" class="hidden bg-red-100 p-6 rounded-lg mb-8 border-l-4 border-red-500">
                <h2 class="text-xl font-semibold text-red-800 mb-3">錯誤：URL 中未找到問題參數 ('q')。</h2>
                <p class="text-red-700">Error: Question parameter missing.</p>
                <p class="text-red-600 mt-4">請聯絡記者以取得一個包含完整問題參數的正確連結。</p>
            </div>
            
            <!-- 回覆區塊 (預設隱藏，當問題存在時才顯示) -->
            <form id="reply-form" class="space-y-6 hidden">
                <div>
                    <label for="response" class="block text-sm font-medium text-gray-700 mb-2">您的回覆 / Your Response</label>
                    <textarea id="response" rows="8" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 transition duration-150 ease-in-out p-4 border resize-y" placeholder="請在此輸入您的採訪回覆..."></textarea>
                </div>
                
                <button type="submit" class="w-full flex justify-center py-3 px-4 border border-transparent rounded-lg shadow-md text-base font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition duration-300 ease-in-out transform hover:scale-[1.01]">
                    提交回覆並返回 App (Submit & Return)
                </button>
                <div id="status-message" class="text-center mt-4 text-sm font-medium"></div>
            </form>
        </main>
    </div>

    <script type="module">
        // -------------------------------------------------------------
        // Firebase 導入與初始化邏輯
        // -------------------------------------------------------------
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, addDoc, collection, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // 設定 Firebase Log 級別為 Debug (有助於偵錯)
        setLogLevel('Debug');
        
        // 取得環境提供的 Firebase 專屬變數 (MANDATORY)
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId;
        let isFirebaseReady = false;

        /**
         * 初始化 Firebase 應用程式並處理認證。
         */
        const initFirebase = async () => {
            if (!firebaseConfig) {
                console.error("Firebase 配置資訊 (firebaseConfig) 遺失。無法初始化。");
                isFirebaseReady = false;
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                // 根據環境 token 進行認證，如果沒有則匿名登入
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                
                // 取得用戶 ID，如果登入失敗則使用隨機 UUID 作為識別碼
                userId = auth.currentUser?.uid || crypto.randomUUID();
                console.log("Firebase 初始化成功。當前使用者 ID:", userId);
                isFirebaseReady = true;

            } catch (error) {
                console.error("Firebase 初始化或認證失敗:", error);
                // 即使認證失敗，仍嘗試使用隨機 ID，以便測試提交邏輯
                userId = crypto.randomUUID();
                isFirebaseReady = false;
            }
        };


        // 頁面載入時執行主邏輯
        document.addEventListener('DOMContentLoaded', async () => {
            // 步驟 1: 初始化 Firebase 
            await initFirebase();
            
            // 步驟 2: 處理 URL 參數
            const params = new URLSearchParams(window.location.search);
            const questionParam = params.get('q');
            
            const questionDisplay = document.getElementById('question-display');
            const questionContent = document.getElementById('question-content');
            const errorMessage = document.getElementById('error-message');
            const replyForm = document.getElementById('reply-form');
            const statusMessage = document.getElementById('status-message');
            const submitButton = replyForm.querySelector('button[type="submit"]');

            let questionText = '';

            if (questionParam) {
                try {
                    // 解碼 URL 編碼的問題內容
                    questionText = decodeURIComponent(questionParam);
                    questionContent.textContent = questionText;
                    
                    // 顯示問題和回覆表單
                    questionDisplay.classList.remove('hidden');
                    replyForm.classList.remove('hidden');
                    errorMessage.classList.add('hidden');

                } catch (e) {
                    console.error("Error decoding URL parameter:", e);
                    questionDisplay.classList.add('hidden');
                    replyForm.classList.add('hidden');
                    errorMessage.classList.remove('hidden');
                }
            } else {
                // 'q' 參數不存在，顯示錯誤訊息
                questionDisplay.classList.add('hidden');
                replyForm.classList.add('hidden');
                errorMessage.classList.remove('hidden');
            }


            // 步驟 3: 處理表單提交
            replyForm.addEventListener('submit', async (e) => {
                e.preventDefault();

                if (!isFirebaseReady) {
                    statusMessage.className = 'text-center mt-4 text-sm font-medium text-red-600';
                    statusMessage.textContent = '錯誤：Firebase 尚未準備好，請稍候或檢查連線。';
                    return;
                }

                const responseText = document.getElementById('response').value.trim();
                
                if (responseText === "") {
                    statusMessage.className = 'text-center mt-4 text-sm font-medium text-red-600';
                    statusMessage.textContent = '回覆內容不能為空。';
                    return;
                }

                submitButton.disabled = true;
                submitButton.textContent = '提交中...';
                statusMessage.className = 'text-center mt-4 text-sm font-medium text-indigo-600';
                statusMessage.textContent = '正在提交回覆並數位存證...';

                // -------------------------------------------------------------
                // Firebase 提交邏輯
                // -------------------------------------------------------------
                try {
                    const responseData = {
                        question: questionText,
                        response: responseText,
                        respondentId: userId,
                        timestamp: new Date(),
                        // 假設記者名稱是固定的，或需要從其他 URL 參數獲取
                        reporter: 'CHIA-YUAN HSU', 
                        appId: appId
                    };
                    
                    // 存入公共資料集，讓所有使用者/記者都可以看到採訪回覆
                    // 路徑: /artifacts/{appId}/public/data/interview_responses
                    const collectionPath = `artifacts/${appId}/public/data/interview_responses`;
                    await addDoc(collection(db, collectionPath), responseData);

                    statusMessage.className = 'text-center mt-4 text-sm font-medium text-green-600';
                    statusMessage.textContent = '回覆已成功提交並數位存證。';

                    // 提交成功後清除表單
                    document.getElementById('response').value = '';
                    submitButton.disabled = false;
                    submitButton.textContent = '提交回覆並返回 App (Submit & Return)';

                } catch (error) {
                    console.error("Firestore 提交失敗:", error);
                    statusMessage.className = 'text-center mt-4 text-sm font-medium text-red-600';
                    statusMessage.textContent = '提交失敗：請檢查網路連線或聯繫記者。';
                    submitButton.disabled = false;
                    submitButton.textContent = '提交回覆並返回 App (Submit & Return)';
                }
            });
        });
    </script>
</body>
</html>
