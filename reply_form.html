<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Firebase 連線檢查</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 使用 Inter 字體並確保全頁面居中 */
        body { font-family: 'Inter', sans-serif; background-color: #f7f9fc; }
    </style>
</head>
<body class="p-4 md:p-8 flex items-center justify-center min-h-screen">

    <div id="app-container" class="bg-white p-6 md:p-10 rounded-xl shadow-2xl w-full max-w-lg">
        <h1 class="text-3xl font-bold text-center text-indigo-700 mb-6">Firebase 連線狀態檢查</h1>
        
        <div id="status-message" class="bg-gray-100 p-4 rounded-lg text-center font-medium text-gray-700">
            嘗試連線到 Firebase...
        </div>

        <div class="mt-8 space-y-3">
            <div class="flex flex-col">
                <span class="text-sm font-semibold text-gray-500">應用程式 ID (Project ID)</span>
                <span id="display-app-id" class="p-2 bg-indigo-50 text-indigo-800 rounded-md break-all text-sm font-mono">載入中...</span>
            </div>
            
            <div class="flex flex-col">
                <span class="text-sm font-semibold text-gray-500">使用者 ID (User UID)</span>
                <span id="display-user-id" class="p-2 bg-indigo-50 text-indigo-800 rounded-md break-all text-sm font-mono">尚未登入...</span>
            </div>

            <div class="flex flex-col">
                <span class="text-sm font-semibold text-gray-500">授權狀態</span>
                <span id="display-auth-status" class="p-2 bg-indigo-50 text-indigo-800 rounded-md break-all text-sm font-mono">等待驗證...</span>
            </div>
        </div>
    </div>
    
    <script type="module">
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// 你的 firebaseConfig（你已提供）
const firebaseConfig = {
  apiKey: "AIzaSyBIxsCqay_XEbrI2U9WiUHfnetD5aT7tqI",
  authDomain: "lkjhhggg.firebaseapp.com",
  projectId: "lkjhhggg",
  storageBucket: "lkjhhggg.firebasestorage.app",
  messagingSenderId: "626715718039",
  appId: "1:626715718039:web:4bd597eb04f8b21c0854d2",
  measurementId: "G-P7MMWBE4VP"
};

const firebaseApp = initializeApp(firebaseConfig);
const auth = getAuth(firebaseApp);
const db = getFirestore(firebaseApp);

// Cloud Function submit URL -> 請改成你部署後的 URL
const CLOUD_SUBMIT_URL = "https://us-central1-lkjhhggg.cloudfunctions.net/submitResponse";

// 若無登入，使用匿名登入
async function ensureAnonymousAuth() {
  const user = auth.currentUser;
  if (!user) {
    try {
      await signInAnonymously(auth);
      console.log("已匿名登入");
    } catch (e) {
      console.error("匿名登入失敗", e);
      throw e;
    }
  }
}

// 呼叫 Cloud Function 提交回覆
async function submitResponseToServer(linkJwtToken, answersObj, responderInfoObj) {
  // 確保已登入（匿名）
  await ensureAnonymousAuth();

  // 取得 ID token
  const idToken = await auth.currentUser.getIdToken(true);

  const body = {
    token: linkJwtToken,      // 從 URL (token) 拿到的 JWT
    answers: answersObj,      // 例如 { q1: "回答1" }
    responderInfo: responderInfoObj // 例如 { nickname: "匿名A" }
  };

  const resp = await fetch(CLOUD_SUBMIT_URL, {
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Authorization": `Bearer ${idToken}`
    },
    body: JSON.stringify(body)
  });

  return resp.json();
}

// 頁面上的 submit 按鈕事件範例
async function onSubmitClick() {
  try {
    const urlParams = new URLSearchParams(window.location.search);
    const tokenFromUrl = urlParams.get("token"); // JWT from link
    if (!tokenFromUrl) {
      alert("未偵測到 token，無法提交。");
      return;
    }

    const responseText = document.getElementById("response-text").value.trim();
    const nickname = document.getElementById("nickname") ? document.getElementById("nickname").value.trim() : "匿名";

    if (!responseText) {
      alert("請輸入回覆內容");
      return;
    }

    // 構造 answers 與 responderInfo 格式，可依需求擴充
    const answers = { text: responseText };
    const responderInfo = { nickname };

    const result = await submitResponseToServer(tokenFromUrl, answers, responderInfo);
    if (result && result.success) {
      alert("提交成功，感謝您的回覆！");
      // 可顯示回覆 id： result.id
    } else {
      alert("提交失敗: " + JSON.stringify(result));
    }
  } catch (err) {
    console.error(err);
    alert("提交過程發生錯誤: " + err.message);
  }
}

// 綁定按鈕
document.getElementById("submit-button").addEventListener("click", onSubmitClick);

// 在載入時可註冊 onAuthStateChanged 更新 UI
onAuthStateChanged(auth, (user) => {
  if (user) {
    // 顯示 UID（匿名）
    const uidSpan = document.getElementById("display-user-id");
    if (uidSpan) uidSpan.textContent = user.uid;
  }
});
    </script>
</body>
</html>
